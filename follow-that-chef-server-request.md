#+TITLE:Follow That Request!

* Setup
  - OPC v1.4.4

  - Ubuntu 12.04

  - We will be following a data bag creation deep into the system.
    We'll exclude some details along the way.  If I skip something or
    gloss over something you think is important, ask about it.  If I
    don't know we can follow up afterwards.

  - This request will touch a large portion of the components of OPC:

    - nginx
    - opscode-chef
    - opscode-account
    - opscode-authz
    - couchdb databases (chef_c6fcd0af2f0041768dd49034f0d1a790,
      opscode_account, authorization)
    - postgresql database
    - redis
    - RabbitMQ
    - opscode-expander
    - Solr

  - Please stop me for questions.  If we don't make it all the way
    down the rabbit hole, that's OK.



* Cheating
  - CouchDB log level increased from default.

  - Postgres log level increased.

  - nrpe disabled to reduce noise.

  - A quiet system with no traffic makes this much easier than it
    often is on customer installations or in prod.

#+BEGIN_SRC ruby
couchdb['log_level'] = "info"
nrpe['enable'] = false
#+END_SRC

/opt/opscode/embedded/cookbooks/private-chef/templates/default/postgresql.conf.erb
#+BEGIN_EXAMPLE
log_statement = 'all'                   # none, ddl, mod, all
#+END_EXAMPLE

* Follow that Request!
** Knife Request

   All of the interesting knife commands eventually result in an HTTP
   request to the Chef Server's API.

#+BEGIN_EXAMPLE
sdanna@gaius ~/presentations/follow-that-request > knife data bag create foo -VV
DEBUG: Signing the request as admin
DEBUG: Sending HTTP Request via POST to 172.31.6.136:443/organizations/ftr-org//data
DEBUG: ---- HTTP Status and Header Data: ----
DEBUG: HTTP 1.1 201 Created
DEBUG: server: nginx/1.2.3
DEBUG: date: Fri, 08 Feb 2013 06:29:12 GMT
DEBUG: content-type: application/json; charset=utf-8
DEBUG: transfer-encoding: chunked
DEBUG: connection: close
DEBUG: status: 201 Created
DEBUG: ---- End HTTP Status/Header Data ----
Created data_bag[foo]
#+END_EXAMPLE

** nginx

Nginx listens on port 80 and 443 and routes/load balances our requests
to the proper service. Below we can see the nginx log for the request
we just made:

/var/log/opscode/nginx/access.log

#+BEGIN_EXAMPLE
172.28.3.170 - - [08/Feb/2013:06:29:12 +0000]  "POST /organizations/ftr-org//data HTTP/1.1" 201 "1.356" 72 "-" "Chef Knife/11.2.0 (ruby-1.9.2-p320; ohai-6.16.0; x86_64-darwin11.3.0; +http://opscode.com)" "127.0.0.1:9460" "201" "0.733" "11.2.0" "algorithm=sha1;version=1.0;" "admin" "2013-02-08T06:29:11Z" "HMzhEUx3526K9M/Dwl6a1/At6Ns=" 1012
#+END_EXAMPLE

Every API request is routed to one of three services:

- opscode-erchef
- opscode-account
- opscode-erchef

As we can see from the log, nginx routed the request to port 9460 on
localhost. On OPC opscode-chef listens on 9460.

This is all configured via configuration files generated by Chef.

/var/opt/opscode/nginx/etc/nginx.conf
#+BEGIN_EXAMPLE
  upstream opscode_chef {
    server 127.0.0.1:9460;
  }
#+END_EXAMPLE

/var/opt/opscode/nginx/etc/chef_https_lb.conf
#+BEGIN_EXAMPLE
    location ~ "^/organizations/[a-z0-9-_]+?/data/{0,1}.*$" {
        set $my_upstream opscode_chef;
        if ($http_x_ops_userid = "") {
                set $my_upstream opscode_webui;
        }
        proxy_redirect http://$my_upstream /;
        proxy_pass http://$my_upstream;
    }
#+END_EXAMPLE

** opscode-chef

Opscode-chef is a fork of the Chef 10 Server. Below we can see the
data_bag creation that nginx fowarded to it.

/var/log/opscode/opscode-chef/current
#+BEGIN_EXAMPLE
2013-02-08_06:29:12.62474  ~ Started request handling: 2013-02-08 06:29:11 +0000
2013-02-08_06:29:12.62476  ~ Params: {"name"=>"foo", "controller"=>"data_bags", "action"=>"create", "organization_id"=>"ftr-org", "format"=>nil}
2013-02-08_06:29:12.62476  ~ {:before_filters_time=>0.082888854, :after_filters_time=>0.00010993, :action_time=>0.730682359, :dispatch_time=>0.732592257}
2013-02-08_06:29:12.62477  ~
2013-02-08_06:29:12.62477
#+END_EXAMPLE

*** Authentication
   *Are you who you say you are?*

   Every API request is sent with signed headers.  These headers are
   signed with a private key of a user or client.  The server knows
   the public key and can verify it.

   To get the public key and verify the request, we first need to
   determine whether this is a user or client. We "query" couchdb to
   see if it is a client:

/var/log/opscode/couchdb/current
#+BEGIN_EXAMPLE
2013-02-08_06:29:11.90881 [info] [<0.301.0>] 127.0.0.1 - - 'GET' /chef_c6fcd0af2f0041768dd49034f0d1a790/_design/Mixlib::Authorization::Models::Client-fec21b157b76e08b86e92ef7cbc2be81/_view/by_clientname?key=%22admin%22&include_docs=true 200
#+END_EXAMPLE

   We can't check the response code of this request, rather we need to look at the body.

#+BEGIN_EXAMPLE
root@ftr-server:~# curl "http://localhost:5984/chef_c6fcd0af2f0041768dd49034f0d1a790/_design/Mixlib::Authorization::Models::Client-fec21b157b76e08b86e92ef7cbc2be81/_view/by_clientname?key=%22admin%22&include_docs=true"
{"total_rows":1,"offset":0,"rows":[]}
#+END_EXAMPLE

   Since it isn't a client, it is probably a user. Let's ask postgresql!

#+BEGIN_EXAMPLE
2013-02-08_07:15:57.69466 LOG:  statement: SELECT "id", "authz_id", "username", "pubkey_version", "public_key" FROM "users" WHERE ("username" = 'admin') LIMIT 1
#+END_EXAMPLE

Great! Now we hopefully have the user's public_key and can use that to verify the signed headers on the HTTP request.

*** Authorization
   *Do you have permission to take this action?*

   Hosted and Private Chef have a role-based access control system
   that allows the user to specify fine-grained control over objects.

   For each request by a user we have answer two questions:

   1. Is the user in this organization?
   2. Is the user authorized for this action?

**** Are you in this org?

     That's easy, we can use opscode-account to get the list of orgs
     for this user:

#+BEGIN_EXAMPLE
2013-02-08_06:29:11.97569  ~ Started request handling: 2013-02-08 06:29:11 +0000
2013-02-08_06:29:11.97570  ~ Params: {"controller"=>"users", "action"=>"show_orgs", "user_id"=>"admin"}
2013-02-08_06:29:11.97571  ~ {:before_filters_time=>0.003511148, :after_filters_time=>0.000131883, :action_time=>0.054468057, :dispatch_time=>0.054896197}
#+END_EXAMPLE

     Opscode-account eventually asks couchdb:

#+BEGIN_EXAMPLE
2013-02-08_06:29:11.96801 [info] [<0.303.0>] 127.0.0.1 - - 'GET' /opscode_account/_design/OrganizationUser-5c1085b0dd852acf9c74bbfe97f66406/_view/by_organizations_for_user?startkey=%22e0dd2f8c71b711e289d5fa163e3cd918%22&endkey=%22e0dd2f8c71b711e289d5fa163e3cd918%22&include_docs=false 200
2013-02-08_06:29:11.97332 [info] [<0.315.0>] 127.0.0.1 - - 'GET' /opscode_account/98823f3b50ce4f6bac7fb02831de5d24 200
#+END_EXAMPLE

**** Do you have permission to create data bags?!

     To create a databag, we need CREATE on the data bags container.
     First, we need to find the data bag container and its authz_id:

#+BEGIN_EXAMPLE
2013-02-08_06:29:11.99311 [info] [<0.320.0>] 127.0.0.1 - - 'GET' /chef_c6fcd0af2f0041768dd49034f0d1a790/_design/Mixlib::Authorization::Models::Container-f6aead5acfa18f649f9f951ad5570324/_view/by_containername?key=%22data%22&include_docs=true 200
2013-02-08_06:29:12.00884 [info] [<0.321.0>] 127.0.0.1 - - 'GET' /opscode_account/_design/Mixlib::Authorization::AuthJoin-25834c5a8d6a9586adb05320f3f725e8/_view/by_user_object_id?
key=%220ddfbf1a5d9be68078b6332220efca38%22&include_docs=true 200
#+END_EXAMPLE

     Now that we have an authz_id, lets ask opscode-authz

/var/log/opscode/opscode-authz/authz.log.1
#+BEGIN_EXAMPLE
2013-02-08T06:29:12Z authz@127.0.0.1 INFO status=200; method=GET; path=/containers/0ddfbf1a5d9be68078b6332220f0a2ea/acl/create/actors/fbcf10c6fa9b9053b4a93da39f169d09; request_resource=actor_level_authorization_resource; request_time_ms=2; requestor=fbcf10c6fa9b9053b4a93da39f169d09; request_id=authz-F5C0C03BD2528B6602DB70AE6B5A4C91
#+END_EXAMPLE

    Status code 200 means "ACCESS GRANTED". Authz stores its data in
    couch, but uses redis as a cache.

*** Database Insertion
   *Ensure we can get the data back later*

   Now, we stick this data bag into couchdb:

#+BEGIN_EXAMPLE
2013-02-08_06:29:12.06244 [info] [<0.331.0>] 127.0.0.1 - - 'GET' /chef_c6fcd0af2f0041768dd49034f0d1a790/_design/id_map/_view/name_to_id?key=[%22data_bag%22,%22foo%22] 200
2013-02-08_06:29:12.06692 [info] [<0.341.0>] 127.0.0.1 - - 'PUT' /chef_c6fcd0af2f0041768dd49034f0d1a790/18e8351b-8e2f-45cf-9511-76ff1a12cfee 201
2013-02-08_06:29:12.22874 [info] [<0.343.0>] 127.0.0.1 - - 'PUT' /chef_c6fcd0af2f0041768dd49034f0d1a790/bc4b63ca2fd961c2411f71e0b01f5138 201
#+END_EXAMPLE

*** Search Update
   *Ensure the data is available via search.*

   The new data is put on RabbitMQ

/var/log/opscode/opscode-chef/current
#+BEGIN_EXAMPLE
2013-02-08_06:29:12.07577 [Fri, 08 Feb 2013 06:29:12 +0000] INFO: Sending data_bag(18e8351b-8e2f-45cf-9511-76ff1a12cfee) to the index queue for addition.
2013-02-08_06:29:12.17304 ~ Qrack::Queue#publish will be removed in Bunny 0.8. Use direct_exchange = bunny.exchange(''); direct_exchange.publish('message', key: queue.name) if you want to publish directly to one given queue. For more informations see https://github.com/ruby-amqp/bunny/issues/15 and for more theoretical explanation check http://bit.ly/nOF1CK
#+END_EXAMPLE

  From opscode-chef's perspective, its job is done.  Sometime later,
  opscode-expander removes the item from the queue and inserts it into
  Solr.

/var/log/opscode/opscode-expander/current
#+BEGIN_EXAMPLE
2013-02-08_06:29:12.18669 [Fri, 08 Feb 2013 06:29:12 +0000] INFO: indexed data_bag[18e8351b-8e2f-45cf-9511-76ff1a12cfee] database[chef_c6fcd0af2f0041768dd49034f0d1a790] transit,xml,solr-post | 0,0.0002951622009277344,0.011533737182617188 |
#+END_EXAMPLE

/var/log/opscode/opscode-solr/current
#+BEGIN_EXAMPLE
2013-02-08_06:29:12.18276 d  commit{dir=/var/opt/opscode/opscode-solr/data/index,segFN=segments_7,version=1360303947200,generation=7,filenames=[_0.tis, _5.prx, _5.fdt, _1.frq, _4.prx, _4.fnm, _2.tii, _3.fdt, _1.fnm, _4.fdx, _4.frq, _5.tis, _5.nrm, _0.prx, _3.nrm, _0.fnm, _2.prx, _2.fdt, _2.frq, _3.prx, _2.fdx, _5.tii, _1.fdx, _1.prx, _2.tis, _0.tii, _1.fdt, _0.frq, _2.nrm, _1.nrm, _3.frq, _3.tii, _3.fnm, _1.tii, _4.tis, _0.nrm, _4.tii, _5.fnm, _1.tis, _4.nrm, _4.fdt, _5.frq, _2.fnm, _3.fdx, segments_7, _5.fdx, _0.fdx, _5_1.del, _0.fdt, _3.tis]}
#+END_EXAMPLE

*** Authorization Data Creation
   *Ensure our new object has a record in the authorization database*

    1. Remember the AuthJoin for the data bag container?  The data bag
       will need one too, so we will need one of those.

#+BEGIN_EXAMPLE
2013-02-08_06:29:12.35786 [info] [<0.350.0>] 127.0.0.1 - - 'PUT' /opscode_account/bc4b63ca2fd961c2411f71e0b03e36ad 201
#+END_EXAMPLE

    2. Now we ask opscode-authz to create a new "object" and update
       its acls.

#+BEGIN_EXAMPLE
2013-02-08T06:29:12Z authz@127.0.0.1 INFO status=201; method=POST; path=/objects; request_resource=objects_resource; request_time_ms=21; requestor=fbcf10c6fa9b9053b4a93da39f169d09; request_id=authz-171FC8C510486D3AA76E36CA3F70601D2013-02-08T06:29:12Z authz@127.0.0.1 INFO status=200; method=GET; path=/containers/0ddfbf1a5d9be68078b6332220f0a2ea/acl; request_resource=acl_resource; request_time_ms=5; requestor=98823f3b50ce4f6bac7fb02831000834; request_id=authz-89B5DF609F1822CFC72D2F31501234522013-02-08T06:29:12Z authz@127.0.0.1 INFO status=200; method=GET; path=/objects/bc4b63ca2fd961c2411f71e0b01f519a/acl; request_resource=acl_resource; request_time_ms=68; requestor=fbcf10c6fa9b9053b4a93da39f169d09; request_id=authz-C2F78BC958381D2CCAC58B37479853D32013-02-08T06:29:12Z authz@127.0.0.1 INFO status=200; method=GET; path=/objects/bc4b63ca2fd961c2411f71e0b01f519a/acl/create; request_resource=action_level_authorization_resource; request_time_ms=5; requestor=fbcf10c6fa9b9053b4a93da39f169d09; request_id=authz-2BFF1110DA1661B8FD1D7D95C2090DA82013-02-08T06:29:12Z authz@127.0.0.1 INFO status=200; method=PUT; path=/objects/bc4b63ca2fd961c2411f71e0b01f519a/acl/create; request_resource=action_level_authorization_resource; request_time_ms=12; requestor=fbcf10c6fa9b9053b4a93da39f169d09; request_id=authz-39764CA8D2EC8D0A52EDA549D36F8E7B
2013-02-08T06:29:12Z authz@127.0.0.1 INFO status=200; method=GET; path=/objects/bc4b63ca2fd961c2411f71e0b01f519a/acl/read; request_resource=action_level_authorization_resource; request_time_ms=6; requestor=fbcf10c6fa9b9053b4a93da39f169d09; request_id=authz-8AAC3A1B18562B2F2560D230082E1A1A
2013-02-08T06:29:12Z authz@127.0.0.1 INFO status=200; method=PUT; path=/objects/bc4b63ca2fd961c2411f71e0b01f519a/acl/read; request_resource=action_level_authorization_resource; request_time_ms=15; requestor=fbcf10c6fa9b9053b4a93da39f169d09; request_id=authz-965F3A96959F5A4156E2ED8A6344A1E8
2013-02-08T06:29:12Z authz@127.0.0.1 INFO status=200; method=GET; path=/objects/bc4b63ca2fd961c2411f71e0b01f519a/acl/update; request_resource=action_level_authorization_resource; request_time_ms=10; requestor=fbcf10c6fa9b9053b4a93da39f169d09; request_id=authz-3FFF1C522D495617CA21724B43F4E277
2013-02-08T06:29:12Z authz@127.0.0.1 INFO status=200; method=PUT; path=/objects/bc4b63ca2fd961c2411f71e0b01f519a/acl/update; request_resource=action_level_authorization_resource; request_time_ms=19; requestor=fbcf10c6fa9b9053b4a93da39f169d09; request_id=authz-7F9EF7CE716C67412BA3B81F944DC353
2013-02-08T06:29:12Z authz@127.0.0.1 INFO status=200; method=GET; path=/objects/bc4b63ca2fd961c2411f71e0b01f519a/acl/delete; request_resource=action_level_authorization_resource; request_time_ms=3; requestor=fbcf10c6fa9b9053b4a93da39f169d09; request_id=authz-318AFD6B4998D69C0F19E054BE7A4DBA
2013-02-08T06:29:12Z authz@127.0.0.1 INFO status=200; method=PUT; path=/objects/bc4b63ca2fd961c2411f71e0b01f519a/acl/delete; request_resource=action_level_authorization_resource; request_time_ms=10; requestor=fbcf10c6fa9b9053b4a93da39f169d09; request_id=authz-E77CEBD58638567C26F0B47D9A7BFE2B
2013-02-08T06:29:12Z authz@127.0.0.1 INFO status=200; method=GET; path=/objects/bc4b63ca2fd961c2411f71e0b01f519a/acl/grant; request_resource=action_level_authorization_resource; request_time_ms=4; requestor=fbcf10c6fa9b9053b4a93da39f169d09; request_id=authz-2E9B81FE0AC5766971CCBB589BD20405
2013-02-08T06:29:12Z authz@127.0.0.1 INFO status=200; method=PUT; path=/objects/bc4b63ca2fd961c2411f71e0b01f519a/acl/grant; request_resource=action_level_authorization_resource; request_time_ms=9; requestor=fbcf10c6fa9b9053b4a93da39f169d09; request_id=authz-7A560EF4565BC01BB41BE494194E67B7
2013-02-08T06:29:12Z authz@127.0.0.1 INFO status=200; method=GET; path=/objects/bc4b63ca2fd961c2411f71e0b01f519a/acl; request_resource=acl_resource; request_time_ms=8; requestor=fbcf10c6fa9b9053b4a93da39f169d09; request_id=authz-F8F40573DC8A17535A6B0E46FCBEA96E
#+END_EXAMPLE

